---
lab:
  title: 랩 6 - 모니터링을 통해 성능 문제 격리
  module: Monitor and optimize operational resources in Azure SQL
---

# 모니터링을 통해 성능 문제 파악

**예상 시간:** 30분

학생들은 단원에서 파악한 정보를 사용하여 AdventureWorksLT 내에서 진행되는 디지털 혁신 프로젝트의 결과물을 확인합니다. Azure Portal과 다른 도구를 살펴보며 학생은 도구를 활용하여 성능 관련 문제를 식별하고 해결하는 방법을 결정합니다.

데이터베이스 관리자는 성능 관련 문제를 식별하고 발견된 문제를 해결하는 실행 가능한 솔루션을 제공하도록 고용됩니다. Azure Portal을 사용하여 성능 문제를 식별한 다음 해결하는 방법을 제안해야 합니다.

> &#128221; 이러한 연습에서는 T-SQL 코드를 복사하여 붙여넣고 기존 SQL 리소스를 활용하도록 요청합니다. 코드를 실행하기 전에 코드를 올바르게 복사했는지 확인하세요.

## 환경을 설정합니다.

랩 가상 머신이 제공되고 미리 구성된 경우 **C:\LabFiles** 폴더에서 랩 파일을 준비해야 합니다. *파일이 이미 있는지 잠시 확인하려면 이 섹션을 건너뜁니다.* 그러나 사용자 개인의 컴퓨터를 사용 중이거나 랩 파일이 없는 경우 계속하려면 *GitHub*에서 복제해야 합니다.

1. 랩 가상 머신 또는 로컬 컴퓨터에 제공되지 않은 경우 Visual Studio Code 세션을 시작합니다.

1. 명령 팔레트(Ctrl+Shift+P)를 열고 **Git: Clone**을 입력합니다. **Git: Clone** 옵션을 선택합니다.

1. 다음 URL을 **리포지토리 URL** 필드에 붙여넣고 **Enter** 키를 선택합니다.

    ```url
    https://github.com/MicrosoftLearning/dp-300-database-administrator.git
    ```

1. 랩 가상 머신 또는 로컬 컴퓨터가 제공되지 않은 경우 **C:\LabFiles** 폴더에 저장합니다(없는 경우 폴더 만들기).

## Azure에서 SQL Server 설정

Azure에 로그인하고 Azure에서 실행 중인 기존 Azure SQL Server 인스턴스가 있는지 확인합니다. *Azure에서 실행 중인 SQL Server 인스턴스가 이미 있는 경우 이 섹션을 건너뜁니다.*

1. 랩 가상 머신 또는 로컬 컴퓨터가 제공되지 않은 경우 Visual Studio Code 세션을 시작하고 이전 섹션에서 복제된 리포지토리로 이동합니다.

1. **/Allfiles/Labs** 폴더를 마우스 오른쪽 단추로 클릭하고 **통합 터미널에서 열기**를 선택합니다.

1. Azure CLI를 사용하여 Azure에 연결해 보겠습니다. 다음 명령을 입력하고 **Enter** 키를 선택합니다.

    ```bash
    az login
    ```

    > &#128221; 브라우저 창이 열립니다. Azure 자격 증명을 사용하여 로그인합니다.

1. Azure에 로그인한 후에는 리소스 그룹이 아직 없는 경우 리소스 그룹을 만들고 해당 리소스 그룹 아래에 SQL Server 및 데이터베이스를 만듭니다. 다음 명령을 입력하고 **Enter** 키를 선택합니다. *스크립트를 완료하는 데 몇 분 정도 걸립니다.*

    ```bash
    cd ./Setup
    ./deploy-sql-database.ps1
    ```

    > &#128221; 기본적으로 이 스크립트는 **contoso-rg**라는 리소스 그룹을 만들거나, 있는 경우 *contoso-rg*로 시작하는 리소스를 사용합니다. 기본적으로 **미국 서부 2** 지역(westus2)에도 모든 리소스가 만들어집니다. 마지막으로 **SQL 관리자 암호**에 대한 임의의 12자 암호를 생성합니다. 이러한 값은 고유 값으로 **-rgName**, **-location** 및 **-sqlAdminPw** 매개 변수 중 하나 이상을 사용하여 변경할 수 있습니다. 암호는 12자 이상의 Azure SQL 암호 복잡성 요구 사항을 충족해야 하며 대문자 1개, 소문자 1개, 숫자 1개, 특수 문자 1개 이상을 포함해야 합니다.

    > &#128221; 스크립트는 SQL Server 방화벽 규칙에 현재 공용 IP 주소를 추가합니다.

1. 스크립트가 완료되면 리소스 그룹 이름, SQL Server 이름 및 데이터베이스 이름, 관리자 사용자 이름 및 암호를 반환합니다. *이러한 값은 랩의 뒷부분에서 필요하므로 기록해 두십시오*.

---

## Azure Portal에서 CPU 사용률 검토

1. 랩 가상 머신 또는 로컬 컴퓨터가 제공되지 않은 경우 브라우저 세션을 시작하고 [https://portal.azure.com](https://portal.azure.com/)으로 이동합니다. Azure 자격 증명을 사용하여 Portal에 연결합니다.

1. Azure Portal의 맨 위에 있는 검색 상자에서 *SQL Server*를 검색한 다음 옵션 목록에서 **SQL Server**를 클릭합니다.

1. SQL Server **dp300-lab-xxxxxxxx**를 선택합니다. 여기서 *xxxxxxxx* 는 임의의 숫자 문자열입니다.

    > &#128221; 이 랩에서 만들지 않은 사용자 고유의 Azure SQL Server를 사용하는 경우 해당 SQL 서버의 이름을 선택합니다.

1. SQL Server 서버 기본 페이지에 있는 **보안**에서 **네트워킹**을 선택합니다.

1. **네트워킹** 페이지에서 현재 공용 IP가 **방화벽 규칙** 목록에 이미 추가되었는지 확인하고, 없으면 **+ 클라이언트 IPv4 주소(IP 주소) 추가**를 선택하여 추가한 후 **저장**을 선택합니다.

1. Azure SQL Server의 기본 블레이드에서 **설정** 섹션으로 이동하고 **SQL Database**를 선택한 후 **AdventureWorksLT** 데이터베이스를 선택합니다.

1. 왼쪽 탐색에서 **쿼리 편집기(미리 보기)** 를 선택합니다.

    **참고:** 이 기능은 미리 보기로 제공됩니다.

1. SQL Server 관리 사용자 이름을 선택하고 암호 또는 Microsoft Entra 자격 증명(데이터베이스에 연결하도록 할당된 경우)을 입력합니다.
    - **서버 이름:** &lt;여기에 Azure SQL Database 서버 이름 붙여넣기&gt;__
    - **인증:** SQL Server 인증
    - **서버 관리자 로그인:** 사용자의 Azure SQL Database 서버 관리자 로그인
    - **암호:** 사용자의 Azure SQL Database 서버 관리자 암호

1. **쿼리 1**에서 다음 쿼리를 입력하고 **실행**을 선택합니다.

    ```sql
    DECLARE @Counter INT 
    SET @Counter=1
    WHILE ( @Counter <= 10000)
    BEGIN
        SELECT 
             RTRIM(a.Firstname) + ' ' + RTRIM(a.LastName)
            , b.AddressLine1
            , b.AddressLine2
            , RTRIM(b.City) + ', ' + RTRIM(b.StateProvince) + '  ' + RTRIM(b.PostalCode)
            , CountryRegion
            FROM SalesLT.Customer a
            INNER JOIN SalesLT.CustomerAddress c 
                ON a.CustomerID = c.CustomerID
            RIGHT OUTER JOIN SalesLT.Address b
                ON b.AddressID = c.AddressID
        ORDER BY a.LastName ASC
        SET @Counter  = @Counter  + 1
    END
    ```

1. 쿼리가 완료될 때까지 기다립니다.

1. 쿼리를 *두 번* 더 재실행하여 데이터베이스에서 일부 CPU 부하를 생성합니다.

1. **AdventureWorksLT** 데이터베이스의 블레이드에서 **모니터링** 섹션의 **메트릭** 아이콘을 선택합니다.

    *저장하지 않은 변경 내용이 삭제됨* 메시지가 표시되면 **확인**을 선택합니다.

1. **CPU 백분율**을 반영하도록 **메트릭** 메뉴 옵션을 변경한 다음, **평균** **집계**를 선택합니다. 그러면 지정된 시간 프레임의 평균 CPU 백분율이 표시됩니다.

1. 시간 경과에 따른 CPU 평균을 관찰합니다. 쿼리가 실행 중일 때 그래프 끝에 CPU 사용률이 급증하는 것을 확인할 수 있습니다.

## 높은 CPU 쿼리 식별

1. **AdventureWorksLT** 데이터베이스에 대한 블레이드의 **지능형 성능** 섹션에서 **Query Performance Insight** 아이콘을 찾습니다.

1. **설정 다시 설정**을 선택합니다.

1. 그래프 아래의 그리드에서 쿼리를 선택합니다. 이전에 여러 번 실행한 쿼리가 표시되지 않으면 최대 2~5분 동안 기다렸다가 **새로 고침**을 선택합니다.

    > &#128221; 둘 이상의 쿼리가 나열된 경우 각 쿼리를 선택하여 결과를 관찰합니다. 각 쿼리에 사용할 수 있는 많은 양의 정보를 확인할 수 있습니다.

1. 이전에 실행한 쿼리의 경우 총 기간이 1분 이상이며 약 3만 번 실행되었습니다.

1. **쿼리 세부 정보** 페이지의 SQL 텍스트를 실행한 쿼리와 비교하면 **쿼리 세부 정보**에 **WHILE** 루프 또는 기타 문이 아닌 **SELECT** 문만 포함되었음을 알 수 있습니다. 이는 **Query Performance Insight**가 DDL(데이터 정의 언어) 문을 무시하면서 **SELECT, INSERT, UPDATE, DELETE, MERGE,** **BULK INSERT**와 같은 DML(데이터 조작 언어) 문만 추적하는 **쿼리 저장소** 데이터를 사용하기 때문에 발생합니다.

모든 성능 문제가 단일 쿼리 실행에 의한 높은 CPU 사용률과 관련이 있는 것은 아닙니다. 이 경우 쿼리가 수천 번 실행되어 CPU 사용률이 높아질 수도 있습니다.

---

## 리소스 정리

다른 용도로 Azure SQL Server를 사용하지 않는 경우 이 랩에서 만든 리소스를 정리할 수 있습니다.

### 리소스 그룹 삭제

이 랩에 대한 새 리소스 그룹을 만든 경우 리소스 그룹을 삭제하여 이 랩에서 만든 모든 리소스를 제거할 수 있습니다.

1. Azure Portal의 왼쪽 탐색 창에서 **리소스 그룹**을 선택하거나 검색 창에서 **리소스 그룹**을 검색하고 결과에서 선택합니다.

1. 이 랩을 위해 만든 리소스 그룹으로 이동합니다. 리소스 그룹에는 Azure SQL Server 및 이 랩에서 만든 기타 리소스가 포함됩니다.

1. 위쪽 메뉴에서 **리소스 그룹 삭제**를 선택합니다.

1. **리소스 그룹 삭제** 대화 상자에서 확인할 리소스 그룹의 이름을 입력한 다음 **삭제**를 선택합니다.

1. 리소스 그룹이 삭제될 때까지 기다립니다.

1. Azure Portal을 닫습니다.

### 랩 리소스만 삭제합니다.

이 랩에 대한 새 리소스 그룹을 만들지 않았고 리소스 그룹과 이전 리소스를 그대로 유지하려는 경우 이 랩에서 만든 리소스를 계속 삭제할 수 있습니다.

1. Azure Portal의 왼쪽 탐색 창에서 **리소스 그룹**을 선택하거나 검색 창에서 **리소스 그룹**을 검색하고 결과에서 선택합니다.

1. 이 랩을 위해 만든 리소스 그룹으로 이동합니다. 리소스 그룹에는 Azure SQL Server 및 이 랩에서 만든 기타 리소스가 포함됩니다.

1. 랩에서 이전에 지정한 SQL Server 이름이 접두사로 지정된 모든 리소스를 선택합니다.

1. 위쪽 메뉴에서 **삭제**를 선택합니다.

1. **리소스 삭제** 대화 상자에서 **삭제**를 입력하고 **삭제**를 선택합니다.

1. 리소스 삭제를 확인하려면 **삭제**를 다시 선택합니다.

1. 리소스가 삭제될 때까지 기다립니다.

1. Azure Portal을 닫습니다.

### LabFiles 폴더 삭제

이 랩에 대해 새 LabFiles 폴더를 만들었고 더 이상 필요하지 않은 경우 LabFiles 폴더를 삭제하여 이 랩에서 만든 모든 파일을 제거할 수 있습니다.

1. 랩 가상 머신 또는 로컬 컴퓨터가 제공되지 않은 경우 파일 탐색기를 열고 **C:\\** 드라이브로 이동합니다.
1. **LabFiles** 폴더를 마우스 오른쪽 단추로 클릭하고 **삭제**를 선택합니다.
1. **예**를 선택하여 폴더 삭제를 확인합니다.

---

이 랩을 성공적으로 완료하셨습니다.

이 연습에서는 Azure SQL Database의 서버 리소스를 탐색하고 Query Performance Insight를 통해 잠재적인 쿼리 성능 문제를 식별하는 방법을 알아보았습니다.
