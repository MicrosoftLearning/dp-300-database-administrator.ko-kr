---
lab:
  title: 랩5 - -Microsoft Defender for SQL 및 데이터 분류 사용
  module: Implement a Secure Environment for a Database Service
---

# Microsoft Defender for SQL 및 데이터 분류 사용

**예상 시간:** 30분

학생들은 단원에서 파악한 정보를 사용하여 Azure Portal 및 AdventureWorks 내에서 보안 기능을 구성한 후 구현합니다.

선임 데이터베이스 관리자로 고용되어 데이터베이스 환경의 보안을 보장합니다. 작업은 Azure SQL Database에 중점을 둡니다.

> &#128221; 이러한 연습에서는 T-SQL 코드를 복사하여 붙여넣고 기존 SQL 리소스를 활용하도록 요청합니다. 코드를 실행하기 전에 코드를 올바르게 복사했는지 확인하세요.

## 환경을 설정합니다.

랩 가상 머신이 제공되고 미리 구성된 경우 **C:\LabFiles** 폴더에서 랩 파일을 준비해야 합니다. *파일이 이미 있는지 잠시 확인하려면 이 섹션을 건너뜁니다.* 그러나 사용자 개인의 컴퓨터를 사용 중이거나 랩 파일이 없는 경우 계속하려면 *GitHub*에서 복제해야 합니다.

1. 랩 가상 머신 또는 로컬 컴퓨터에 제공되지 않은 경우 Visual Studio Code 세션을 시작합니다.

1. 명령 팔레트(Ctrl+Shift+P)를 열고 **Git: Clone**을 입력합니다. **Git: Clone** 옵션을 선택합니다.

1. 다음 URL을 **리포지토리 URL** 필드에 붙여넣고 **Enter** 키를 선택합니다.

    ```url
    https://github.com/MicrosoftLearning/dp-300-database-administrator.git
    ```

1. 랩 가상 머신 또는 로컬 컴퓨터가 제공되지 않은 경우 **C:\LabFiles** 폴더에 저장합니다(없는 경우 폴더 만들기).

## Azure에서 SQL Server 설정

Azure에 로그인하고 Azure에서 실행 중인 기존 Azure SQL Server 인스턴스가 있는지 확인합니다. *Azure에서 실행 중인 SQL Server 인스턴스가 이미 있는 경우 이 섹션을 건너뜁니다.*

1. 랩 가상 머신 또는 로컬 컴퓨터가 제공되지 않은 경우 Visual Studio Code 세션을 시작하고 이전 섹션에서 복제된 리포지토리로 이동합니다.

1. **/Allfiles/Labs** 폴더를 마우스 오른쪽 단추로 클릭하고 **통합 터미널에서 열기**를 선택합니다.

1. Azure CLI를 사용하여 Azure에 연결해 보겠습니다. 다음 명령을 입력하고 **Enter** 키를 선택합니다.

    ```bash
    az login
    ```

    > &#128221; 브라우저 창이 열립니다. Azure 자격 증명을 사용하여 로그인합니다.

1. Azure에 로그인한 후에는 리소스 그룹이 아직 없는 경우 리소스 그룹을 만들고 해당 리소스 그룹 아래에 SQL Server 및 데이터베이스를 만듭니다. 다음 명령을 입력하고 **Enter** 키를 선택합니다. *스크립트를 완료하는 데 몇 분 정도 걸립니다.*

    ```bash
    cd ./Setup
    ./deploy-sql-database.ps1
    ```

    > &#128221; 기본적으로 이 스크립트는 **contoso-rg**라는 리소스 그룹을 만들거나, 있는 경우 *contoso-rg*로 시작하는 리소스를 사용합니다. 기본적으로 **미국 서부 2** 지역(westus2)에도 모든 리소스가 만들어집니다. 마지막으로 **SQL 관리자 암호**에 대한 임의의 12자 암호를 생성합니다. 이러한 값은 고유 값으로 **-rgName**, **-location** 및 **-sqlAdminPw** 매개 변수 중 하나 이상을 사용하여 변경할 수 있습니다. 암호는 12자 이상의 Azure SQL 암호 복잡성 요구 사항을 충족해야 하며 대문자 1개, 소문자 1개, 숫자 1개, 특수 문자 1개 이상을 포함해야 합니다.

    > &#128221; 스크립트는 SQL Server 방화벽 규칙에 현재 공용 IP 주소를 추가합니다.

1. 스크립트가 완료되면 리소스 그룹 이름, SQL Server 이름 및 데이터베이스 이름, 관리자 사용자 이름 및 암호를 반환합니다. *이러한 값은 랩의 뒷부분에서 필요하므로 기록해 두십시오*.

---

## Microsoft Defender for SQL 사용

1. 랩 가상 머신 또는 로컬 컴퓨터가 제공되지 않은 경우 브라우저 세션을 시작하고 [https://portal.azure.com](https://portal.azure.com/)으로 이동합니다. Azure 자격 증명을 사용하여 Portal에 연결합니다.

1. Azure Portal의 맨 위에 있는 검색 상자에서 *SQL Server*를 검색한 다음 옵션 목록에서 **SQL Server**를 클릭합니다.

1. SQL Server **dp300-lab-xxxxxxxx**를 선택합니다. 여기서 *xxxxxxxx* 는 임의의 숫자 문자열입니다.

    > &#128221; 이 랩에서 만들지 않은 사용자 고유의 Azure SQL Server를 사용하는 경우 해당 SQL 서버의 이름을 선택합니다.

1. *개요* 블레이드에서 *SQL용 Microsoft Defender* 옆에 있는 **구성되지 않음**을 선택합니다.

1. 오른쪽 상단의 **X**를 선택하여 *클라우드용 Microsoft Defender* 개요 창을 닫습니다.

1. *SQL용 Microsoft Defender*에서 **사용**을 선택합니다.

1. 프로덕션 환경에서는 여러 권장 사항이 나열되어야 합니다. **클라우드용 Defender의 모든 권장 사항 보기**를 선택하고 Azure SQL Server에 대해 나열된 모든 *Microsoft Defender* 권장 사항을 검토하고 적절하게 구현하려고 합니다.

## 취약성 평가

1. Azure SQL Server의 기본 블레이드에서 **설정** 섹션으로 이동하고 **SQL Database**를 선택한 후 **AdventureWorksLT**라는 데이터베이스를 선택합니다.

1. **보안**에서 **클라우드용 Microsoft Defender**를 선택합니다.

1. 오른쪽 상단의 **X**를 선택하여 *클라우드용 Microsoft Defender* 개요 창을 닫고 `AdventureWorksLT` 데이터베이스에 대한 **클라우드용 Microsoft Defender** 대시보드를 확인합니다.

1. 취약성 평가 기능 검토를 시작하려면 **취약성 평가 결과**에서 **취약성 평가 추가 결과 확인**을 선택합니다.  

1. 최신 취약성 평가 결과를 얻으려면 **검사**를 선택합니다. 이 프로세스는 몇 분 정도 걸리며, 취약성 평가는 데이터베이스를 검사합니다.

1. 모든 보안 위험에는 위험 수준(높음, 중간 또는 낮음)과 추가 정보가 있습니다. 시행되는 규칙은 [인터넷 보안 센터](https://www.cisecurity.org/benchmark/microsoft_sql_server/?azure-portal=true)에서 제공하는 벤치마크를 기준으로 합니다. **결과** 탭에서 취약성을 선택합니다. 취약성의 **ID**(예 **: VA1143**)가 나열된 경우 기록해 둡니다.

1. 보안 검사에 따라 대체 보기와 권장 사항이 제공됩니다. 제공된 정보를 검토합니다. 이 보안 검사의 경우 **모든 결과를 기준으로 추가** 단추를 선택한 다음 **예**를 선택하여 기준을 설정할 수 있습니다. 기준이 마련되었으므로 이후 스캔에서 결과가 기준과 다른 경우 이 보안 검사는 실패합니다. 오른쪽 위에 있는 **X**를 선택하여 특정 규칙의 창을 닫습니다.  

1. **검사**를 다시 실행하여 선택한 취약성이 보안 검사에서 이제 *통과됨*으로 표시되는지 확인해 보겠습니다.

    앞서 통과한 보안 검사를 선택하면 구성한 기준을 볼 수 있을 것입니다. 향후 변경 사항이 있을 경우 취약성 평가 검사는 이를 감지하며 보안 검사에 실패하게 됩니다.  

## Advanced Threat Protection

1. 오른쪽 위에 있는 **X**를 선택하여 취약성 평가 창을 닫고 데이터베이스용 **클라우드용 Microsoft Defender** 대시보드로 돌아갑니다. **보안 인시던트 및 경고**에서 항목을 볼 수 없습니다. 이는 **Advanced Threat Protection**에서 문제가 검색되지 않았음을 의미합니다. Advanced Threat Protection은 비정상적이며 잠재적으로 유해할 수 있는 데이터베이스 액세스 또는 악용 시도를 나타내는 비정상적인 활동을 탐지합니다.  

    > &#128221; 이 단계에서는 보안 경고가 표시되지 않을 것입니다. 다음 단계에서는 Advanced Threat Protection의 결과를 검토할 수 있도록 경고를 트리거하는 테스트를 실행합니다.  

    Advanced Threat Protection을 사용하면 다음 중 하나가 발생하는 것으로 의심되는 경우 위협을 식별하고 경고를 표시할 수 있습니다.  

    - SQL 삽입
    - SQL 삽입 취약성
    - 데이터 반출
    - 안전하지 않은 작업
    - 무차별 암호 대입 공격
    - 비정상적인 클라이언트 로그인

    이 섹션에서는 SQL 삽입 경고가 어떻게 SSMS를 통해 트리거될 수 있는지 알아봅니다. SQL 삽입 경고는 SSMS와 같은 표준 도구가 아닌 사용자가 작성한 애플리케이션을 위한 것입니다. 따라서 SSMS를 통해 SQL 삽입에 대한 테스트로 경고를 트리거하려면 **애플리케이션 이름**(SQL Server 또는 Azure SQL에 연결하는 클라이언트에 대한 연결 속성)을 “설정”해야 합니다.

1. 랩 가상 머신 또는 로컬 컴퓨터가 제공되지 않은 경우 SSMS(SQL Server Management Studio)를 엽니다. 서버에 연결 대화 상자에서 Azure SQL Database 서버의 이름을 붙여넣고 다음 자격 증명으로 로그인합니다.

    - **서버 이름:** &lt;여기에 Azure SQL Database 서버 이름 붙여넣기&gt;__
    - **인증:** SQL Server 인증
    - **서버 관리자 로그인:** 사용자의 Azure SQL Database 서버 관리자 로그인
    - **암호:** 사용자의 Azure SQL Database 서버 관리자 암호

1. **연결**을 선택합니다.

1. SSMS에서 **파일** > **새로 만들기** > **데이터베이스 엔진 쿼리**를 선택하여 새 연결을 사용하는 쿼리를 만듭니다.  

1. 기본 로그인 창에서 늘 하던 대로 SQL 인증 및 Azure SQL Server 이름과 관리자 자격 증명을 사용하여 **AdventureWorksLT** 데이터베이스에 로그인합니다. 연결하기 전에 **옵션 >>** > **연결 속성**을 선택합니다. **데이터베이스에 연결** 옵션에 **AdventureWorksLT**를 입력합니다.  

1. **추가 연결 매개 변수** 탭을 선택하고 텍스트 상자에 다음 연결 문자열을 삽입합니다.  

    ```sql
    Application Name=webappname
    ```

1. **연결**을 선택합니다.  

1. 새 쿼리 창에서 다음 쿼리를 붙여넣은 다음, **실행**을 선택합니다.  

    ```sql
    SELECT * FROM sys.databases WHERE database_id like '' or 1 = 1 --' and family = 'test1';
    ```

1. Azure Portal에서 **AdventureWorksLT** 데이터베이스로 이동합니다. 왼쪽 창의 **보안** 아래에서 **클라우드용 Microsoft Defender**를 선택합니다.

1. 클라우드용 Microsoft Defender**보안 인시던트 및 경고** 아래에서 **클라우드용 Defender의 이 리소스에 대한 경고 확인**을 선택합니다.  

1. 이제 전체 보안 경고를 볼 수 있습니다.  

1. 좀 더 구체적인 경고를 표시하고 조사 단계를 수신하려면 **잠재적 SQL 삽입**을 선택합니다.

1. **전체 세부 정보 보기**를 선택하여 경고의 세부 정보를 표시합니다.

1. **경고 세부 정보** 탭 아래에 *취약한 문*이 표시됩니다. 경고를 트리거하기 위해 실행된 SQL 문입니다. SSMS에서 실행된 SQL 문이기도 합니다. 또한 **클라이언트 응용 프로그램**은 **webappname**으로 표시됩니다. SSMS의 연결 문자열에 지정한 이름입니다.

1. 정리 단계로, SSMS의 모든 쿼리 편집기를 닫고 모든 연결을 제거하여 다음 연습에서 실수로 추가 경고를 트리거하지 않도록 하는 것이 좋습니다.

## 데이터 분류 사용

1. Azure SQL Server의 기본 블레이드에서 **설정** 섹션으로 이동하고 **SQL Database**를 선택한 후 **AdventureWorksLT**라는 데이터베이스를 선택합니다.

1. **AdventureWorksLT** 데이터베이스의 기본 블레이드에서 **보안** 섹션으로 이동한 다음, **데이터 검색 및 분류**를 선택합니다.

1. **데이터 검색 및 분류** 페이지에는 다음과 같은 정보 메시지가 표시됩니다. **현재 SQL Information Protection 정책을 사용하고 있습니다. 분류 권장 사항이 있는 15개의 열을 찾았습니다**. 해당 링크를 선택합니다.

1. 다음 **데이터 검색 및 분류** 화면에서 **모두 선택** 옆의 확인란을 선택하고, **선택한 권장 사항 적용**을 선택한 다음 **저장**을 선택하여 분류를 데이터베이스에 저장합니다.

1. **데이터 검색 및 분류** 화면으로 돌아가서 15개의 열이 5개의 다른 테이블에서 성공적으로 분류되었음을 확인합니다. 각 열에 대한 *정보 유형* 및 *민감도 레이블* 을 검토합니다.

## 데이터 분류 및 마스킹 구성

1. Azure Portal에서 **AdventureWorksLT** Azure SQL Database 인스턴스(논리 서버가 아님)로 이동합니다.

1. 왼쪽 창의 **보안**에서 **데이터 검색 및 분류**를 선택합니다.  

1. SalesLT Customer 테이블에서 *데이터 검색 및 분류*는 `FirstName` 및 `LastName`을 분류해야 하는 것을 식별했지만 `MiddleName`은 식별하지 못했습니다. 드롭다운 목록을 사용하여 지금 추가합니다. *민감도 레이블*에 대한 *정보 유형* 및 **기밀 - GDPR**의 **이름**을 선택한 후 **분류 추가**를 선택합니다.  

1. **저장**을 선택합니다.

1. **개요** 탭에서 분류가 추가되었는지 확인하고, `MiddleName`이 이제 SalesLT 스키마의 분류된 열 목록에 표시되는지 확인합니다.

1. 왼쪽 창에서 **개요**를 선택하여 데이터베이스의 개요로 돌아갑니다.  

   DDM(동적 데이터 마스킹)은 Azure SQL 및 SQL Server에서 모두 사용할 수 있습니다. DDM은 이런 유형의 규칙을 코딩해야 하는 애플리케이션 수준 대신 SQL Server 수준에서 권한 없는 사용자를 대상으로 중요한 데이터를 마스킹하여 데이터 노출을 제한합니다. Azure SQL에서 마스킹할 항목을 권장합니다. 또는 마스크를 수동으로 추가할 수도 있습니다.

   다음 단계에서는 이전 단계에서 검토한 `FirstName`, `MiddleName` 및 `LastName` 열을 마스킹합니다.  

1. Azure Portal에서 Azure SQL Database로 이동합니다. 왼쪽 창에 있는 **보안**에서 **동적 데이터 마스킹**을 선택한 다음, **마스크 추가**를 선택합니다.  

1. 드롭다운 목록에서 **SalesLT** 스키마, **고객** 테이블 및 **FirstName** 열을 선택합니다. 마스킹 옵션을 검토할 수 있지만 이 시나리오에서는 기본값이 적합합니다. **추가**를 선택하여 마스킹 규칙을 추가합니다.  

1. 해당 테이블의 **MiddleName** 및 **LastName**에 대해 이전 단계를 반복합니다.  

    현재 세 가지 마스킹 규칙이 있습니다.  

1. **저장**을 선택합니다.

    > &#128221; Azure SQL Server 이름이 소문자, 숫자 및 대시로만 구성되지 않으면 이 단계가 실패하고 데이터 마스킹 섹션을 계속할 수 없습니다.

1. 왼쪽 창에서 **개요**를 선택하여 데이터베이스의 개요로 돌아갑니다.

## 분류 및 마스킹된 데이터 검색

다음에는 분류된 열을 쿼리하는 사람을 시뮬레이션하고 작동 중인 동적 데이터 마스킹을 탐색합니다.

1. SSMS(SQL Server Management Studio)로 이동하여 Azure SQL Server에 연결하고 새 쿼리 창을 엽니다.

1. **AdventureWorksLT** 데이터베이스를 마우스 오른쪽 단추로 클릭하고 **새 쿼리**를 선택합니다.  

1. 다음 쿼리를 실행하면 분류된 데이터, 그리고 경우에 따라 마스킹된 데이터로 표시되는 열이 반환됩니다. **실행**을 선택하여 쿼리를 실행합니다.

    ```sql
    SELECT TOP 10 FirstName, MiddleName, LastName
    FROM SalesLT.Customer;
    ```

    결과에는 마스킹이 적용되지 않은 처음 10개의 이름이 표시됩니다. 그 이유는 사용자가 Azure SQL Database 논리 서버에 대한 관리자이기 때문입니다.  

1. 다음 쿼리에서는 새 사용자를 만들고 이전 쿼리를 해당 사용자로 실행합니다. 또한 `EXECUTE AS`를 사용하여 `Bob`을 가장합니다. `EXECUTE AS` 문을 실행하면 세션의 실행 컨텍스트가 로그인 또는 사용자로 전환됩니다. 이에 따라 `EXECUTE AS` 명령을 실행하는 사용자(이 경우에는 본인) 대신 로그인 또는 사용자에 대해 사용 권한을 확인합니다. `REVERT`는 로그인 또는 사용자의 가장을 중지하는 데 사용됩니다.  

    이전 연습의 내용이 반복되므로 다음에 나오는 명령의 처음 몇 부분이 익숙할 수 있습니다. 다음 명령을 사용하여 새 쿼리를 만든 다음, **실행**을 선택하여 쿼리를 실행하고 결과를 관찰합니다.

    ```sql
    -- Create a new SQL user and give them a password
    CREATE USER Bob WITH PASSWORD = 'c0mpl3xPassword!';

    -- Until you run the following two lines, Bob has no access to read or write data
    ALTER ROLE db_datareader ADD MEMBER Bob;
    ALTER ROLE db_datawriter ADD MEMBER Bob;

    -- Execute as our new, low-privilege user, Bob
    EXECUTE AS USER = 'Bob';
    SELECT TOP 10 FirstName, MiddleName, LastName
    FROM SalesLT.Customer;
    REVERT;
    ```

    이제 결과에 처음 10개의 이름이 표시되지만, 이번에는 마스킹이 적용된 상태입니다. Bob에게는 마스킹되지 않은 데이터에 대한 액세스 권한이 부여되지 않았습니다.  

    만약 어떠한 이유로든 Bob에게 이름에 대한 액세스가 필요해서 해당 액세스 권한을 얻게 된다면 어떻게 해야 할까요?  

    **보안**에 있는 **동적 데이터 마스킹** 창으로 이동하여 Azure Portal에서 마스킹에서 제외된 사용자를 업데이트할 수 있지만, T-SQL을 사용하여 이를 수행할 수도 있습니다.

1. **AdventureWorks** 데이터베이스를 마우스 오른쪽 단추로 클릭하고 **새 쿼리**를 선택한 후 다음 쿼리를 입력하여 Bob이 마스킹 없이 이름 결과를 쿼리할 수 있도록 합니다. **실행**을 선택하여 쿼리를 실행합니다.

    ```sql
    GRANT UNMASK TO Bob;  
    EXECUTE AS USER = 'Bob';
    SELECT TOP 10 FirstName, MiddleName, LastName
    FROM SalesLT.Customer;
    REVERT;  
    ```

    결과에는 이름 전체가 포함되어야 합니다.  

1. 새 쿼리에서 다음 T-SQL 명령을 실행하여 사용자의 마스킹 해제 권한을 제거하고 해당 작업을 확인할 수도 있습니다.  

    ```sql
    -- Remove unmasking privilege
    REVOKE UNMASK TO Bob;  

    -- Execute as Bob
    EXECUTE AS USER = 'Bob';
    SELECT TOP 10 FirstName, MiddleName, LastName
    FROM SalesLT.Customer;
    REVERT;  
    ```

    결과에는 마스킹된 이름이 포함되어야 합니다.  

---

## 리소스 정리

다른 용도로 Azure SQL Server를 사용하지 않는 경우 이 랩에서 만든 리소스를 정리할 수 있습니다.

### 리소스 그룹 삭제

이 랩에 대한 새 리소스 그룹을 만든 경우 리소스 그룹을 삭제하여 이 랩에서 만든 모든 리소스를 제거할 수 있습니다.

1. Azure Portal의 왼쪽 탐색 창에서 **리소스 그룹**을 선택하거나 검색 창에서 **리소스 그룹**을 검색하고 결과에서 선택합니다.

1. 이 랩을 위해 만든 리소스 그룹으로 이동합니다. 리소스 그룹에는 Azure SQL Server 및 이 랩에서 만든 기타 리소스가 포함됩니다.

1. 위쪽 메뉴에서 **리소스 그룹 삭제**를 선택합니다.

1. **리소스 그룹 삭제** 대화 상자에서 확인할 리소스 그룹의 이름을 입력한 다음 **삭제**를 선택합니다.

1. 리소스 그룹이 삭제될 때까지 기다립니다.

1. Azure Portal을 닫습니다.

### 랩 리소스만 삭제합니다.

이 랩에 대한 새 리소스 그룹을 만들지 않았고 리소스 그룹과 이전 리소스를 그대로 유지하려는 경우 이 랩에서 만든 리소스를 계속 삭제할 수 있습니다.

1. Azure Portal의 왼쪽 탐색 창에서 **리소스 그룹**을 선택하거나 검색 창에서 **리소스 그룹**을 검색하고 결과에서 선택합니다.

1. 이 랩을 위해 만든 리소스 그룹으로 이동합니다. 리소스 그룹에는 Azure SQL Server 및 이 랩에서 만든 기타 리소스가 포함됩니다.

1. 랩에서 이전에 지정한 SQL Server 이름이 접두사로 지정된 모든 리소스를 선택합니다.

1. 위쪽 메뉴에서 **삭제**를 선택합니다.

1. **리소스 삭제** 대화 상자에서 **삭제**를 입력하고 **삭제**를 선택합니다.

1. 리소스 삭제를 확인하려면 **삭제**를 다시 선택합니다.

1. 리소스가 삭제될 때까지 기다립니다.

1. Azure Portal을 닫습니다.

### LabFiles 폴더 삭제

이 랩에 대해 새 LabFiles 폴더를 만들었고 더 이상 필요하지 않은 경우 LabFiles 폴더를 삭제하여 이 랩에서 만든 모든 파일을 제거할 수 있습니다.

1. 랩 가상 머신 또는 로컬 컴퓨터가 제공되지 않은 경우 파일 탐색기를 열고 **C:\\** 드라이브로 이동합니다.
1. **LabFiles** 폴더를 마우스 오른쪽 단추로 클릭하고 **삭제**를 선택합니다.
1. **예**를 선택하여 폴더 삭제를 확인합니다.

---

이 랩을 성공적으로 완료하셨습니다.

이 연습에서는 Microsoft Defender for SQL을 사용하도록 설정하여 Azure SQL Database의 보안을 강화해 보았습니다. 또한 Azure Portal 권장 사항에 따라 분류된 열을 만들었습니다.
